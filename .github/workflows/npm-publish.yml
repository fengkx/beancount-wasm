name: Publish Package

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      profile:
        description: "Build profile"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - debug-symbols
      npm_tag:
        description: "npm dist-tag"
        required: true
        default: "latest"
        type: choice
        options:
          - latest
          - debug
      version:
        description: "Expected package version (optional)"
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Resolve publish target
        id: target
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PROFILE="${{ inputs.profile }}"
            NPM_TAG="${{ inputs.npm_tag }}"
            EXPECTED_VERSION="${{ inputs.version }}"
          else
            REF_NAME="${GITHUB_REF_NAME}"
            if [[ "$REF_NAME" == *-debug.* ]]; then
              PROFILE="debug-symbols"
              NPM_TAG="debug"
            else
              PROFILE="release"
              NPM_TAG="latest"
            fi
            EXPECTED_VERSION=""
          fi

          if [[ "$PROFILE" == "release" && "$NPM_TAG" != "latest" ]]; then
            echo "Invalid combination: profile=release requires npm_tag=latest" >&2
            exit 1
          fi
          if [[ "$PROFILE" == "debug-symbols" && "$NPM_TAG" != "debug" ]]; then
            echo "Invalid combination: profile=debug-symbols requires npm_tag=debug" >&2
            exit 1
          fi

          PACKAGE_VERSION="$(node -p "require('./package/package.json').version")"
          if [[ -n "$EXPECTED_VERSION" && "$EXPECTED_VERSION" != "$PACKAGE_VERSION" ]]; then
            echo "Version mismatch: expected=$EXPECTED_VERSION package=$PACKAGE_VERSION" >&2
            exit 1
          fi

          echo "profile=$PROFILE" >> "$GITHUB_OUTPUT"
          echo "npm_tag=$NPM_TAG" >> "$GITHUB_OUTPUT"
          echo "package_version=$PACKAGE_VERSION" >> "$GITHUB_OUTPUT"

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Build wheels
        run: ./scripts/build-wheels.sh --profile "${{ steps.target.outputs.profile }}" v2 v3

      - name: Sync wheel metadata
        run: node ./scripts/sync-wheel-metadata.mjs --profile "${{ steps.target.outputs.profile }}"

      - name: Build package
        run: pnpm -C package build

      - name: Verify package profile
        run: node ./scripts/verify-package-profile.mjs --expect "${{ steps.target.outputs.profile }}"

      - name: Publish
        run: npm publish --tag "${{ steps.target.outputs.npm_tag }}" --provenance --access public
        working-directory: package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
