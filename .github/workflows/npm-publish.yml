name: Publish Package

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Resolve versions from tag
        id: versions
        run: |
          set -euo pipefail

          TAG_NAME="${GITHUB_REF_NAME}"
          BASE_VERSION="${TAG_NAME#v}"

          if [[ "$BASE_VERSION" == "$TAG_NAME" ]]; then
            echo "Tag must start with 'v': $TAG_NAME" >&2
            exit 1
          fi

          if [[ ! "$BASE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag must be vX.Y.Z (got: $TAG_NAME)" >&2
            exit 1
          fi

          RELEASE_VERSION="$BASE_VERSION"
          DEBUG_VERSION="${BASE_VERSION}-debug.0"

          echo "release_version=$RELEASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "debug_version=$DEBUG_VERSION" >> "$GITHUB_OUTPUT"

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Build and publish release (latest)
        run: |
          set -euo pipefail

          node -e "const fs=require('fs');const p='package/package.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));j.version='${{ steps.versions.outputs.release_version }}';fs.writeFileSync(p,JSON.stringify(j,null,2)+'\n');"

          ./scripts/build-wheels.sh --profile release v2 v3
          node ./scripts/sync-wheel-metadata.mjs --profile release
          node ./scripts/verify-package-profile.mjs --expect release

          pnpm -C package build
          node -e "const p=require('./package/package.json'); console.log('release package:', p.name, p.version)"
          (cd package && npm pack --json >/tmp/beancount-wasm-release-pack.json && cat /tmp/beancount-wasm-release-pack.json)
          # OIDC trusted publishing (no long-lived token). Provenance is disabled
          # because CI mutates package/package.json version based on the pushed tag,
          # so the published tarball does not byte-match the tagged source tree.
          (
            cd package
            npm publish --tag latest --access public
          )
        env:
          XBUILDENV_INSTALL_RETRIES: "6"
          XBUILDENV_RETRY_DELAY_SEC: "5"

      - name: Build and publish debug-symbols (debug)
        run: |
          set -euo pipefail

          node -e "const fs=require('fs');const p='package/package.json';const j=JSON.parse(fs.readFileSync(p,'utf8'));j.version='${{ steps.versions.outputs.debug_version }}';fs.writeFileSync(p,JSON.stringify(j,null,2)+'\n');"

          ./scripts/build-wheels.sh --profile debug-symbols v2 v3
          node ./scripts/sync-wheel-metadata.mjs --profile debug-symbols
          node ./scripts/verify-package-profile.mjs --expect debug-symbols

          pnpm -C package build
          node -e "const p=require('./package/package.json'); console.log('debug package:', p.name, p.version)"
          (cd package && npm pack --json >/tmp/beancount-wasm-debug-pack.json && cat /tmp/beancount-wasm-debug-pack.json)
          # Keep OIDC auth. Provenance is disabled for the same reason as release:
          # package/package.json is rewritten in CI to synthesize the publish
          # version, and debug additionally publishes a different semver than the
          # pushed git tag.
          (
            cd package
            npm publish --tag debug --access public
          )
        env:
          XBUILDENV_INSTALL_RETRIES: "6"
          XBUILDENV_RETRY_DELAY_SEC: "5"
